specs:
  - type: widl
    with:
      filename: spec.widl

compute:
  type: stream

resources:
  db:
    type: postgres
    with:
      url: postgres://postgres:postgres@host.docker.internal:5432/nanobus

codecs:
  avro:
    type: confluentavro
    with:
      schemaRegistryURLs:
        - http://localhost:8081

services:
  'customers.v1.Inbound':
    createCustomer____ignore:
      name: Saves the customer to the database
      steps:
        - name: Set the customer key
          uses: '@dapr/set_state'
          with:
            store: statestore
            key: input.id

        - name: Upsert the customer table
          uses: '@dapr/sql_exec'
          with:
            name: postgres
            sql: |
              INSERT INTO customers (id, first_name, last_name)
              VALUES (:input.id, :input.firstName, :input.lastName)
              ON CONFLICT ON CONSTRAINT customers_pkey
              DO UPDATE SET first_name = :input.firstName, last_name = :input.lastName;

        - name: Publish a message
          uses: '@dapr/publish_message'
          with:
            pubsub: pubsub
            topic: test_topic
            codec: avro
            codecArgs:
              - 1
            # format: cloudevents+json
            # data: |
            #   {
            #     "type": "customer.created",
            #     "data": input
            #   }

        - name: Return the input as the response
          uses: assign
          with:
            value: input

providers:
  'customers.v1.Outbound':
    saveCustomer:
      name: Saves the customer to the database
      steps:
        - name: Set the customer key
          uses: '@dapr/set_state'
          with:
            store: statestore
            key: input.id

        - name: Upsert the customer table
          uses: '@dapr/sql_exec'
          with:
            name: postgres
            sql: |
              INSERT INTO customers (id, first_name, last_name)
              VALUES (:input.id, :input.firstName, :input.lastName)
              ON CONFLICT ON CONSTRAINT customers_pkey
              DO UPDATE SET first_name = :input.firstName, last_name = :input.lastName;

    getCustomers:
      name: Query the database for customers
      steps:
        - name: Query customers
          uses: '@postgres/query'
          with:
            resource: db
            sql: SELECT id, first_name, last_name, email FROM customers

    fetchCustomer:
      name: Loads the customer from the database
      steps:
        - name: Get the state
          uses: '@dapr/get_state'
          with:
            store: statestore
            key: input.id

    customerCreated:
      name: Send a message to the customer
      steps:
        - name: Publish a message
          uses: '@dapr/publish_message'
          with:
            pubsub: pubsub
            topic: test_topic
            codec: avro
            codecArgs:
              - 1
            # format: cloudevents+json
            # data: |
            #   {
            #     "type": "customer.created",
            #     "data": input
            #   }
