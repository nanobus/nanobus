specs:
  - type: widl
    with:
      filename: spec.widl

compute:
  type: wapc
  with:
    filename: build/customers.wasm

filters:
  http:
    - type: jwt
      with:
        rsaPublicKeyFile: ../../public.pem

codecs:
  avro:
    type: confluentavro
    with:
      schemaRegistryURLs:
        - http://localhost:8081

errors:
  permission_denied:
    type: PermissionDenied
    code: permission_denied
    title: Permission denied
    message: You are not authorized to perform this operation.

  customer_not_found:
    type: CustomerNotFound
    code: not_found
    title: Customer not found
    message: Customer {{ .key }} not found

services:
  'customers.v1.Inbound':
    getCustomer:
      summary: Gets the customer record
      steps:
        - summary: Authorize
          name: authorize
          with:
            has:
              - foo
        - summary: forward
          name: invoke

    createCustomer____ignore:
      summary: Saves the customer to the database
      steps:
        - summary: Authorize the user
          name: authorize
          with:
            check:
              scope: dummy

        - summary: Set the customer key
          name: '@dapr/set_state'
          with:
            store: statestore
            key: input.id

        - summary: Upsert the customer table
          name: '@dapr/sql_exec'
          with:
            name: postgres
            sql: |
              INSERT INTO customers (id, first_name, last_name)
              VALUES (:input.id, :input.firstName, :input.lastName)
              ON CONFLICT ON CONSTRAINT customers_pkey
              DO UPDATE SET first_name = :input.firstName, last_name = :input.lastName;

        - summary: Publish a message
          name: '@dapr/publish_message'
          with:
            pubsub: pubsub
            topic: test_topic
            codec: avro
            codecArgs:
              - 1
            # format: cloudevents+json
            # data: |
            #   {
            #     "type": "customer.created",
            #     "data": input
            #   }

        - summary: Return the input as the response
          name: assign
          with:
            value: input

providers:
  'customers.v1.Outbound':
    saveCustomer:
      summary: Saves the customer to the database
      steps:
        - summary: Set the customer key
          name: '@dapr/set_state'
          with:
            store: statestore
            key: input.id

        - summary: Upsert the customer table
          name: '@dapr/sql_exec'
          with:
            name: postgres
            sql: |
              INSERT INTO customers (id, first_name, last_name)
              VALUES (:input.id, :input.firstName, :input.lastName)
              ON CONFLICT ON CONSTRAINT customers_pkey
              DO UPDATE SET first_name = :input.firstName, last_name = :input.lastName;

    fetchCustomer:
      summary: Loads the customer from the database
      steps:
        - summary: Get the state
          name: '@dapr/get_state'
          with:
            store: statestore
            key: input.id
            notFoundError: customer_not_found

    customerCreated:
      summary: Send a message to the customer
      steps:
        - summary: Publish a message
          name: '@dapr/publish_message'
          with:
            pubsub: pubsub
            topic: test_topic
            codec: avro
            codecArgs:
              - 1
            # format: cloudevents+json
            # data: |
            #   {
            #     "type": "customer.created",
            #     "data": input
            #   }
