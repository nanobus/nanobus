compute:
  type: mux

codecs:
  avro:
    type: confluentavro
    with:
      schemaRegistryURLs:
        - http://localhost:8081

subscriptions:
  - pubsub: pubsub
    topic: test_topic
    codec: avro
    #function: receiveMessage

resiliency:
  retries:
    pubsub:
      policy: constant
      duration: 3s

  circuitBreakers:
    pubsub:
      maxRequests: 2
      timeout: 30s

events:
  "io.nanobus.examples.customers.Customer":
    name: Receives the customer message
    steps:
      - name: Send to route
        uses: invoke
        with:
          namespace: welcome.v1.Inbound
          operation: greetCustomer
          input: input.data
        retry: pubsub
        circuitBreaker: pubsub

  receiveMessage:
    name: Receives the customer message
    steps:
      - name: Routing message
        uses: route
        with:
          routes:
            #- when: input.type == 'customer.created'
            - when: input.type == 'io.nanobus.examples.customers.Customer'
              then:
                - name: Send to route
                  uses: invoke
                  with:
                    namespace: welcome.v1.Inbound
                    operation: greetCustomer
                    input: input.data
                  retry: pubsub
                  circuitBreaker: pubsub

providers:
  'welcome.v1.Outbound':
    sendEmail:
      name: Sends an email to the customer
      steps:
        - name: Pretend to send an email by logging the message
          uses: log
          with:
            format: "Sending email to %s with message %q"
            args:
              - input.email
              - input.message
