compute:
  type: mux
  with:
    baseUrl: http://localhost:8001

subscriptions:

  #- pubsub: pubsub
  #  topic: test_topic
  #  function: receiveMessage

codecs:
  avro:
    type: confluentavro
    with:
      schemaRegistryURLs:
        - http://localhost:8081

resiliency:
  retries:
    pubsub:
      policy: constant
      duration: 3s

  circuitBreakers:
    pubsub:
      maxRequests: 2
      timeout: 30s

inbound:

  receiveMessage:
    summary: Receives the customer message
    actions:
      - summary: Decode Avro
        name: decode
        with:
          codec: avro
      - summary: Routing message
        name: route
        with:
          routes:
            #- when: input.type == 'customer.created'
            - when: type == 'io.nanobus.examples.customers.Customer'
              then:
                - summary: Send to route
                  name: invoke
                  with:
                    namespace: welcome.v1.Inbound
                    operation: greetCustomer
                    #input: input.data
                  retry: pubsub
                  circuitBreaker: pubsub

outbound:

  'welcome.v1.Outbound':
    sendEmail:
      summary: Sends an email to the customer
      actions:
        - summary: Pretend to send an email by logging the message
          name: log
          with:
            format: "Sending email to %s with message %q"
            args:
              - input.email
              - input.message
